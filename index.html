<!doctype html>

<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stencil A4 Maker</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, system-ui, sans-serif; padding: 16px; max-width: 800px; margin: 0 auto; background: #f5f5f5; }


h3 { margin: 0 0 14px 0; font-size: 18px; }

/* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
#dropZone {
  border: 3px dashed #aaa;
  border-radius: 14px;
  background: #fff;
  text-align: center;
  padding: 36px 20px;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  margin-bottom: 16px;
}
#dropZone.over { border-color: #0071e3; background: #e8f0ff; }
#dropZone.has-file { border-color: #34c759; background: #f0fff4; }
#dropZone .icon { font-size: 48px; line-height: 1; margin-bottom: 8px; }
#dropZone .main-text { font-size: 17px; font-weight: bold; color: #333; }
#dropZone .sub-text  { font-size: 13px; color: #888; margin-top: 4px; }
#fileInput { display: none; }

/* åŸºæº–ã‚µã‚¤ã‚º */
.controls {
  display: flex; align-items: center; gap: 12px;
  background: #fff; border-radius: 12px; padding: 14px 16px;
  margin-bottom: 16px; flex-wrap: wrap;
}
.controls label { font-size: 15px; font-weight: bold; white-space: nowrap; }
.controls input[type="number"] {
  width: 90px; padding: 10px; font-size: 20px; font-weight: bold;
  border: 2px solid #ccc; border-radius: 8px; text-align: center;
}
.controls input[type="number"]:focus { border-color: #0071e3; outline: none; }
.controls .unit { font-size: 16px; color: #555; }
.controls .hint-small { font-size: 12px; color: #999; }

.status { font-size: 13px; color: #555; margin-bottom: 8px; min-height: 18px; }
.error   { color: #c00; }

#dlBtn {
  display: none; margin-bottom: 12px;
  padding: 12px 24px; font-size: 15px;
  background: #34c759; color: #fff;
  border: none; border-radius: 10px; cursor: pointer; text-decoration: none;
}
#outImg { width: 100%; height: auto; border-radius: 8px; border: 1px solid #ddd; display: none; }


  </style>
</head>
<body>
  <h3>Stencil A4 Maker</h3>

  <!-- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->

  <div id="dropZone">
    <div class="icon">ğŸ–¼ï¸</div>
    <div class="main-text">ç”»åƒã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</div>
    <div class="sub-text">ã¾ãŸã¯ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
  </div>
  <input id="fileInput" type="file" accept="image/*" />

  <!-- åŸºæº–ã‚µã‚¤ã‚º -->

  <div class="controls">
    <label for="baseCm">åŸºæº–ã‚µã‚¤ã‚ºï¼ˆé•·è¾ºï¼‰</label>
    <input id="baseCm" type="number" inputmode="decimal" min="0.1" max="25" step="0.1" value="7" />
    <span class="unit">cm</span>
    <span class="hint-small">å¤‰æ›´ã™ã‚‹ã¨è‡ªå‹•ã§å†ç”Ÿæˆã—ã¾ã™</span>
  </div>

  <p class="status" id="status">ç”»åƒã‚’é¸æŠã™ã‚‹ã¨è‡ªå‹•ã§ç”Ÿæˆã—ã¾ã™</p>
  <a id="dlBtn" download="stencil_a4.png">ğŸ’¾ PNG ã‚’ä¿å­˜</a>
  <img id="outImg" alt="output" />

  <script>
    'use strict';

    const DPI = 300; // å›ºå®š
    const MIRROR = true; // å·¦å³åè»¢å›ºå®š

    const $id = (id) => document.getElementById(id);

    // --- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ ---
    const dropZone  = $id('dropZone');
    const fileInput = $id('fileInput');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('over');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('over'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('over');
      const f = e.dataTransfer.files[0];
      if (f && f.type.startsWith('image/')) handleFile(f);
    });

    fileInput.addEventListener('change', () => {
      const f = fileInput.files[0];
      if (f) handleFile(f);
    });

    // åŸºæº–ã‚µã‚¤ã‚ºå¤‰æ›´ã§å†ç”Ÿæˆ
    $id('baseCm').addEventListener('input', () => {
      if (currentDataURL) scheduleGenerate();
    });

    // ---

    let currentDataURL = null;
    let generateTimer  = null;

    function handleFile(file) {
      dropZone.classList.add('has-file');
      dropZone.querySelector('.main-text').textContent = file.name;
      dropZone.querySelector('.sub-text').textContent  = 'åˆ¥ã®ç”»åƒã‚’é¸ã¶ã«ã¯ã‚¿ãƒƒãƒ—';
      showStatus('èª­ã¿è¾¼ã¿ä¸­â€¦');

      const reader = new FileReader();
      reader.onload  = (e) => { currentDataURL = e.target.result; scheduleGenerate(); };
      reader.onerror = ()  => showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
      reader.readAsDataURL(file);
    }

    // çŸ­æ™‚é–“ã«é€£ç¶šå…¥åŠ›ã•ã‚Œã¦ã‚‚1å›ã ã‘ç”Ÿæˆ
    function scheduleGenerate() {
      clearTimeout(generateTimer);
      generateTimer = setTimeout(generate, 300);
    }

    function showStatus(msg, isError = false) {
      const el = $id('status');
      el.textContent = msg;
      el.className = 'status' + (isError ? ' error' : '');
    }

    function cmToPx(cm) { return (cm / 2.54) * DPI; }

    const PAGE_W = Math.round(cmToPx(21.0));
    const PAGE_H = Math.round(cmToPx(29.7));

    function loadImage(dataURL) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload  = () => resolve(img);
        img.onerror = () => reject(new Error('ç”»åƒã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        img.src = dataURL;
      });
    }

    function drawImageTransformed(ctx, img, x, y, w, h, rotate) {
      ctx.save();
      ctx.translate(x + w / 2, y + h / 2);
      if (rotate) ctx.rotate(Math.PI / 2);
      ctx.scale(-1, 1); // å·¦å³åè»¢å›ºå®š
      const dw = rotate ? h : w;
      const dh = rotate ? w : h;
      ctx.drawImage(img, -dw / 2, -dh / 2, dw, dh);
      ctx.restore();
    }

    async function generate() {
      if (!currentDataURL) return;

      const baseCm = parseFloat($id('baseCm').value);
      if (!Number.isFinite(baseCm) || baseCm <= 0) {
        showStatus('åŸºæº–ã‚µã‚¤ã‚ºã«æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
        return;
      }

      showStatus('ç”Ÿæˆä¸­â€¦');

      try {
        const img = await loadImage(currentDataURL);
        const iw  = img.naturalWidth;
        const ih  = img.naturalHeight;
        if (iw === 0 || ih === 0) throw new Error('ç”»åƒã‚µã‚¤ã‚ºãŒä¸æ­£ã§ã™');

        const rotate   = iw > ih;
        const effW     = rotate ? ih : iw;
        const effH     = rotate ? iw : ih;
        const longEdge = effH;

        const canvas  = document.createElement('canvas');
        canvas.width  = PAGE_W;
        canvas.height = PAGE_H;
        const ctx = canvas.getContext('2d', { alpha: false });

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, PAGE_W, PAGE_H);
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        const margin = Math.round(cmToPx(1.0));
        const gap    = Math.round(cmToPx(0.5));

        const contentW = PAGE_W - margin * 2;
        const contentH = PAGE_H - margin * 2;

        function drawSize(cm) {
          const scale = cmToPx(cm) / longEdge;
          return { w: effW * scale, h: effH * scale };
        }

        function tryLayout(nCols, sizes) {
          const cellW = Math.floor((contentW - gap * (nCols - 1)) / nCols);
          for (const cm of sizes) {
            const ds = drawSize(cm);
            if (ds.w > cellW + 0.5 || ds.h > contentH + 0.5) return null;
          }
          const cellH = Math.floor((contentH - gap) / 2);
          return { cellW, cellH };
        }

        function makeCandidates(step, count) {
          const half = Math.floor(count / 2);
          return Array.from({ length: count }, (_, i) => {
            const offset = (i - half) * step;
            return Math.max(0.1, Math.round((baseCm + offset) * 100) / 100);
          });
        }

        const trySets = [
          [5, 0.5], [4, 0.5],
          [5, 1.0], [4, 1.0], [3, 1.0], [2, 1.0], [1, 1.0],
        ];

        let bestLayout = null, bestCms = null, bestStep = 1.0, bestCount = 1;

        for (const [count, step] of trySets) {
          const cms    = makeCandidates(step, count);
          const layout = tryLayout(count, cms);
          if (layout) {
            bestLayout = layout; bestCms = cms; bestStep = step; bestCount = count;
            break;
          }
        }

        if (!bestLayout) {
          bestLayout = { cellW: contentW, cellH: Math.floor((contentH - gap) / 2) };
          bestCms = [baseCm]; bestCount = 1; bestStep = 1.0;
        }

        const { cellW, cellH } = bestLayout;
        const nCols = bestCount;

        const totalUsedW = nCols * cellW + (nCols - 1) * gap;
        const offsetX    = margin + Math.floor((contentW - totalUsedW) / 2);

        let someSingle = false;

        for (let col = 0; col < nCols; col++) {
          const cm    = bestCms[col];
          const ds    = drawSize(cm);
          const cellX = offsetX + col * (cellW + gap);

          const fitsDouble = (ds.h * 2 + gap) <= contentH + 0.5;
          const nRows = fitsDouble ? 2 : 1;
          if (nRows === 1) someSingle = true;

          for (let row = 0; row < nRows; row++) {
            let dy;
            if (nRows === 1) {
              dy = margin + (contentH - ds.h) / 2;
            } else {
              const cellY = margin + row * (cellH + gap);
              dy = cellY + (cellH - ds.h) / 2;
            }
            const dx = cellX + (cellW - ds.w) / 2;
            drawImageTransformed(ctx, img, dx, dy, ds.w, ds.h, rotate);
          }
        }

        // åŸºæº–ã‚µã‚¤ã‚ºæ³¨è¨˜ï¼ˆåè»¢ã—ã¦å³ä¸‹ã«ï¼‰
        const noteFontSize = Math.max(10, Math.round(cmToPx(0.28)));
        const noteText     = `åŸºæº– ${baseCm.toFixed(1)}cm`;
        const noteX = PAGE_W - margin / 2;
        const noteY = PAGE_H - margin / 3;

        ctx.save();
        ctx.font         = `${noteFontSize}px sans-serif`;
        ctx.textBaseline = 'bottom';
        ctx.fillStyle    = '#888';
        // å·¦å³åè»¢å›ºå®šãªã®ã§å¸¸ã«åè»¢
        ctx.translate(noteX, noteY);
        ctx.scale(-1, 1);
        ctx.textAlign = 'left';
        ctx.fillText(noteText, 0, 0);
        ctx.restore();

        const dataUrl = canvas.toDataURL('image/png');
        $id('outImg').src = dataUrl;
        $id('outImg').style.display = 'block';
        $id('dlBtn').href = dataUrl;
        $id('dlBtn').style.display = 'inline-block';

        const stepLabel  = bestStep === 0.5 ? '0.5cmåˆ»ã¿' : '1cmåˆ»ã¿';
        const rotNote    = rotate     ? ' ï¼ 90Â°å›è»¢' : '';
        const singleNote = someSingle ? ' ï¼ ä¸€éƒ¨1æš' : '';
        showStatus(`å®Œäº† â€” ${nCols}ç¨®é¡ ${stepLabel}${rotNote}${singleNote}ã€€` +
          bestCms.map(c => c.toFixed(1) + 'cm').join(' / '));

      } catch (err) {
        console.error(err);
        showStatus('ã‚¨ãƒ©ãƒ¼ï¼š' + (err.message || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ'), true);
      }
    }
  </script>

</body>
</html>
