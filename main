<!doctype html>

<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stencil A4 Maker (Local)</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, system-ui, sans-serif; padding: 16px; max-width: 800px; margin: 0 auto; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 12px; }
    label { display: flex; flex-direction: column; gap: 4px; font-size: 14px; }
    label.inline { flex-direction: row; align-items: center; gap: 6px; }
    input[type="number"] { width: 100px; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; }
    input[type="file"] { max-width: 100%; font-size: 14px; }
    input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    #outImg { width: 100%; height: auto; border: 1px solid #ddd; margin-top: 16px; display: none; }
    .hint { color: #555; font-size: 13px; line-height: 1.6; margin-top: 10px; background: #f8f8f8; padding: 10px 14px; border-radius: 8px; }
    .status { font-size: 12px; color: #444; margin-top: 8px; min-height: 18px; }
    .error { color: #c00; }
    button { padding: 10px 20px; font-size: 15px; background: #0071e3; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    button:not(:disabled):hover { background: #005bb5; }
    #dlBtn { display: none; margin-top: 10px; padding: 10px 20px; font-size: 15px; background: #34c759; color: #fff; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; }
    #dlBtn:hover { background: #28a745; }
  </style>
</head>
<body>
  <h3 style="margin:0 0 12px 0;">Stencil A4 Makerï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</h3>

  <div class="row">
    <label>
      ç”»åƒã‚’é¸æŠ
      <input id="file" type="file" accept="image/*" />
    </label>
    <label>
      åŸºæº–ã‚µã‚¤ã‚ºï¼ˆcmï¼‰
      <input id="baseCm" type="number" inputmode="decimal" min="0.1" max="25" step="0.1" value="7" />
    </label>
    <label>
      å‡ºåŠ› DPI
      <input id="dpi" type="number" min="72" max="600" step="1" value="300" />
    </label>
    <label class="inline">
      <input id="mirror" type="checkbox" checked />
      å·¦å³åè»¢
    </label>
    <button id="make">ç”Ÿæˆ</button>
  </div>

  <div class="hint">
    ãƒ»åŸºæº–ã‚µã‚¤ã‚ºã‚’ä¸­å¿ƒã«æœ€å¤§5ç¨®é¡ã‚’è‡ªå‹•é…ç½®ã—ã¾ã™<br/>
    ãƒ»4ç¨®é¡ä»¥ä¸Š â†’ <b>0.5cmåˆ»ã¿</b>ã€3ç¨®é¡ä»¥ä¸‹ â†’ <b>1cmåˆ»ã¿</b><br/>
    ãƒ»ä¸Šä¸‹2æšãŒå¹²æ¸‰ã™ã‚‹å ´åˆã¯1æšã®ã¿ã«è‡ªå‹•èª¿æ•´ã—ã¾ã™<br/>
    ãƒ»æ¨ªé•·ã®ç”»åƒã¯è‡ªå‹•ã§90åº¦å›è»¢ã—ã¾ã™<br/>
    ãƒ»A4å³ä¸‹ã«åŸºæº–ã‚µã‚¤ã‚ºã‚’è¨˜è¼‰ã—ã¾ã™ï¼ˆåè»¢ã‚ã‚Šæ™‚ã¯æ–‡å­—ã‚‚åè»¢ï¼‰
  </div>

  <p class="status" id="status"></p>
  <a id="dlBtn" download="stencil_a4.png">ğŸ’¾ PNG ã‚’ä¿å­˜</a>
  <img id="outImg" alt="output" />

  <script>
    'use strict';

    const $id = (id) => document.getElementById(id);

    function cmToPx(cm, dpi) { return (cm / 2.54) * dpi; }

    function a4Px(dpi) {
      return {
        w: Math.round(cmToPx(21.0, dpi)),
        h: Math.round(cmToPx(29.7, dpi)),
      };
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload  = (e) => resolve(e.target.result);
        reader.onerror = ()  => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        reader.readAsDataURL(file);
      });
    }

    function loadImage(dataURL) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload  = () => resolve(img);
        img.onerror = () => reject(new Error('ç”»åƒã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        img.src = dataURL;
      });
    }

    function showStatus(msg, isError = false) {
      const el = $id('status');
      el.textContent = msg;
      el.className = 'status' + (isError ? ' error' : '');
    }

    /**
     * ç”»åƒæç”»ï¼ˆ90åº¦å›è»¢ / å·¦å³åè»¢ å¯¾å¿œï¼‰
     * x,y,w,h ã¯ã€Œå›è»¢å¾Œã€ã®æç”»å…ˆçŸ©å½¢
     */
    function drawImageTransformed(ctx, img, x, y, w, h, mirror, rotate) {
      ctx.save();
      ctx.translate(x + w / 2, y + h / 2);
      if (rotate) ctx.rotate(Math.PI / 2);
      if (mirror) ctx.scale(-1, 1);
      const dw = rotate ? h : w;
      const dh = rotate ? w : h;
      ctx.drawImage(img, -dw / 2, -dh / 2, dw, dh);
      ctx.restore();
    }

    async function generate() {
      const fileInput = $id('file');
      const file = fileInput.files && fileInput.files[0];
      if (!file) { showStatus('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„', true); return; }

      const baseCm = parseFloat($id('baseCm').value);
      if (!Number.isFinite(baseCm) || baseCm <= 0) {
        showStatus('åŸºæº–ã‚µã‚¤ã‚ºã«æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true); return;
      }

      const dpi = parseInt($id('dpi').value, 10);
      if (!Number.isInteger(dpi) || dpi < 72 || dpi > 600) {
        showStatus('DPI ã¯ 72ã€œ600 ã®æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„', true); return;
      }

      const mirror  = $id('mirror').checked;
      const makeBtn = $id('make');
      makeBtn.disabled = true;
      showStatus('èª­ã¿è¾¼ã¿ä¸­â€¦');

      try {
        const dataURL = await readFileAsDataURL(file);
        showStatus('ç”Ÿæˆä¸­â€¦');

        const img = await loadImage(dataURL);
        const iw = img.naturalWidth;
        const ih = img.naturalHeight;
        if (iw === 0 || ih === 0) throw new Error('ç”»åƒã‚µã‚¤ã‚ºãŒä¸æ­£ã§ã™');

        // æ¨ªé•·ãªã‚‰90åº¦å›è»¢ã—ã¦ç¸¦é•·ã¨ã—ã¦æ‰±ã†
        const rotate   = iw > ih;
        const effW     = rotate ? ih : iw;
        const effH     = rotate ? iw : ih;
        const longEdge = effH; // ç¸¦é•·ãªã®ã§é«˜ã•ãŒé•·è¾º

        const { w: pageW, h: pageH } = a4Px(dpi);
        const canvas  = document.createElement('canvas');
        canvas.width  = pageW;
        canvas.height = pageH;
        const ctx = canvas.getContext('2d', { alpha: false });

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, pageW, pageH);
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        // --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šæ•° ---
        const margin = Math.round(cmToPx(1.0, dpi)); // ä½™ç™½ 10mm
        const gap    = Math.round(cmToPx(0.5, dpi)); // gap 5mmå›ºå®š

        const contentW = pageW - margin * 2;
        const contentH = pageH - margin * 2;

        // cm â†’ æç”»ã‚µã‚¤ã‚º(px)
        function drawSize(cm) {
          const scale = cmToPx(cm, dpi) / longEdge;
          return { w: effW * scale, h: effH * scale };
        }

        // nColsåˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ sizes ãŒåã¾ã‚‹ã‹ï¼ˆæ¨ªæ–¹å‘ã®ã¿åˆ¤å®šï¼‰
        // ç¸¦æ–¹å‘ã¯å¾Œã§å„åˆ—ã”ã¨ã«åˆ¤å®šã™ã‚‹ã®ã§ã€ã“ã“ã§ã¯1æšåˆ†ã®é«˜ã•ã§åˆ¤å®š
        function tryLayout(nCols, sizes) {
          const cellW = Math.floor((contentW - gap * (nCols - 1)) / nCols);
          const cellH = Math.floor((contentH - gap) / 2); // 2æšæƒ³å®šã®ã‚»ãƒ«é«˜ã•
          for (const cm of sizes) {
            const ds = drawSize(cm);
            if (ds.w > cellW + 0.5 || ds.h > contentH + 0.5) return null; // 1æšã§ã‚‚ç¸¦ã«å…¥ã‚‰ãªã‘ã‚Œã°ã‚¢ã‚¦ãƒˆ
          }
          return { cellW, cellH };
        }

        function makeCandidates(step, count) {
          const half = Math.floor(count / 2);
          return Array.from({ length: count }, (_, i) => {
            const offset = (i - half) * step;
            return Math.max(0.1, Math.round((baseCm + offset) * 100) / 100);
          });
        }

        const trySets = [
          [5, 0.5],
          [4, 0.5],
          [5, 1.0],
          [4, 1.0],
          [3, 1.0],
          [2, 1.0],
          [1, 1.0],
        ];

        let bestLayout = null;
        let bestCms    = null;
        let bestStep   = 1.0;
        let bestCount  = 1;

        for (const [count, step] of trySets) {
          const cms    = makeCandidates(step, count);
          const layout = tryLayout(count, cms);
          if (layout) {
            bestLayout = layout;
            bestCms    = cms;
            bestStep   = step;
            bestCount  = count;
            break;
          }
        }

        // ä¸‡ä¸€ä½•ã‚‚åã¾ã‚‰ãªã‘ã‚Œã°å¼·åˆ¶
        if (!bestLayout) {
          bestLayout = {
            cellW: contentW,
            cellH: Math.floor((contentH - gap) / 2),
          };
          bestCms   = [baseCm];
          bestCount = 1;
          bestStep  = 1.0;
        }

        const { cellW, cellH } = bestLayout;
        const nCols = bestCount;

        // åˆ—å…¨ä½“ã‚’æ°´å¹³ä¸­å¤®æƒãˆ
        const totalUsedW = nCols * cellW + (nCols - 1) * gap;
        const offsetX    = margin + Math.floor((contentW - totalUsedW) / 2);

        // --- å„åˆ—ã‚’æç”» ---
        let someSingle = false;

        for (let col = 0; col < nCols; col++) {
          const cm    = bestCms[col];
          const ds    = drawSize(cm);
          const cellX = offsetX + col * (cellW + gap);

          // ä¸Šä¸‹2æšç½®ã„ãŸã¨ãå¹²æ¸‰ã—ãªã„ã‹åˆ¤å®š
          // ç”»åƒé«˜ã•Ã—2 + gap ãŒ contentH ã«åã¾ã‚Œã°OK
          const fitsDouble = (ds.h * 2 + gap) <= contentH + 0.5;
          const nRows = fitsDouble ? 2 : 1;
          if (nRows === 1) someSingle = true;

          for (let row = 0; row < nRows; row++) {
            let dy;
            if (nRows === 1) {
              // ç¸¦ä¸­å¤®ã«1æš
              dy = margin + (contentH - ds.h) / 2;
            } else {
              const cellY = margin + row * (cellH + gap);
              dy = cellY + (cellH - ds.h) / 2;
            }
            const dx = cellX + (cellW - ds.w) / 2;
            drawImageTransformed(ctx, img, dx, dy, ds.w, ds.h, mirror, rotate);
          }
        }

        // --- åŸºæº–ã‚µã‚¤ã‚ºæ³¨è¨˜ï¼ˆå³ä¸‹ä½™ç™½ãƒ»mirroræ™‚ã¯æ–‡å­—ã‚‚åè»¢ï¼‰---
        const noteFontSize = Math.max(10, Math.round(cmToPx(0.28, dpi)));
        const noteText     = `åŸºæº– ${baseCm.toFixed(1)}cm`;
        // æç”»åŸºæº–ç‚¹ï¼ˆå³ä¸‹ï¼‰
        const noteX = pageW - margin / 2;
        const noteY = pageH - margin / 3;

        ctx.save();
        ctx.font         = `${noteFontSize}px sans-serif`;
        ctx.textBaseline = 'bottom';
        ctx.fillStyle    = '#888';

        if (mirror) {
          // åŸºæº–ç‚¹ã¸ç§»å‹•ã—ã¦Xè»¸åè»¢ â†’ textAlign:left ã§å³ä¸‹ã«åã¾ã‚‹
          ctx.translate(noteX, noteY);
          ctx.scale(-1, 1);
          ctx.textAlign = 'left';
          ctx.fillText(noteText, 0, 0);
        } else {
          ctx.textAlign = 'right';
          ctx.fillText(noteText, noteX, noteY);
        }
        ctx.restore();

        // --- å‡ºåŠ› ---
        const dataUrl = canvas.toDataURL('image/png');
        $id('outImg').src = dataUrl;
        $id('outImg').style.display = 'block';
        $id('dlBtn').href = dataUrl;
        $id('dlBtn').style.display = 'inline-block';

        const stepLabel   = bestStep === 0.5 ? '0.5cmåˆ»ã¿' : '1cmåˆ»ã¿';
        const rotateNote  = rotate     ? ' ï¼ 90Â°å›è»¢' : '';
        const singleNote  = someSingle ? ' ï¼ ä¸€éƒ¨1æšã®ã¿' : '';
        showStatus(
          `å®Œäº† â€” ${nCols}ç¨®é¡ ${stepLabel}${rotateNote}${singleNote}ã€€` +
          bestCms.map(c => c.toFixed(1) + 'cm').join(' / ') +
          `ã€€${pageW}Ã—${pageH}pxï¼ˆ${dpi}dpiï¼‰`
        );

      } catch (err) {
        console.error(err);
        showStatus('ã‚¨ãƒ©ãƒ¼ï¼š' + (err.message || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ'), true);
      } finally {
        makeBtn.disabled = false;
      }
    }

    $id('make').addEventListener('click', generate);
  </script>

</body>
</html>
